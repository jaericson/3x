#!/usr/bin/env bash
# import -- import an input directory
# Usage: EXPWD=OUTPUTDIR import INPUTDIR...
#
# Author: Jaeho Shin <netj@cs.stanford.edu>
# Created: 2012-11-01
set -eu

[ $# -gt 0 ]        || usage "$0" "At least one INPUTDIR must be given"
[ -n "${EXPWD:-}" ] || usage "$0" "EXPWD must be defined"
EXPWDabbrev=${EXPWD#$PWD/}

shopt -s extglob

# TODO check if cp is GNU coreutil's
cpopts=
be-quiet +1 || cpopts+=--verbose

for path in "$@"; do
    if ! grep -q "^$path$" "$EXPWD"/exp.assembly; then
        msg " importing $path"
        echo "$path" >>"$EXPWD"/exp.assembly
        if [ -d "$path" ]; then
            # a directory containing files and nested patterns
            case $path in
                @(condition|program)/*)
                    # copy files
                    find "$path" -mindepth 1 -maxdepth 1 ! \( -name 'env' \
                        -o -type d -name '*=*' -prune \
                        -o -name 'args' -o -name '+args' -o -name 'args+' \
                        \) -print 2>/dev/null |
                    xargs cp $cpopts --archive --link --target-directory="$EXPWDabbrev"/ |
                    # TODO check and emit error if any files get overwritten
                    sed 's/^/  linking /'
                    # environment variables
                    for f in env; do
                        if [ -r "$path"/$f ]; then
                            msg +1 "  appending $path/$f"
                            no-comments "$path"/$f >>"$EXPWD"/$f
                        fi
                    done
                    # command-line arguments
                    for a in "$path"/{args,+args,args+}; do
                        if [ -r "$a" ]; then
                            case ${a##*/} in
                                args) # replace arguments
                                    ! [ -e "$EXPWD"/args ] || error "$a cannot overwrite already existing args"
                                    cp $cpopts --no-clobber "$a" "$EXPWDabbrev"/args |
                                    sed 's/^/  linking /'
                                    ;;
                                args+) # append arguments
                                    msg +1 "  appending $a"
                                    cat "$a" >>"$EXPWD"/args
                                    ;;
                                +args) # prepend arguments
                                    msg +1 "  prepending $a"
                                    if [ -z "${tmp:-}" ]; then
                                        tmp=$(mktemp /tmp/expkit-import.XXXXXX)
                                        trap "rm -f $tmp" EXIT
                                    fi
                                    cat "$a" "$EXPWD"/args >$tmp
                                    cat $tmp >"$EXPWD"/args
                                    ;;
                            esac
                        fi
                    done
                    ;;
                measure/*)
                    m=$path
                    m=${m#measure/}
                    m=${m%%/*}
                    md="$EXPWD"/exp.measure/"$m"
                    # copy files for measurement
                    mkdir -p "$md"
                    find "$path" -mindepth 1 -maxdepth 1 -print 2>/dev/null |
                    xargs cp $cpopts --archive --link \
                        --target-directory="$md"/ |
                    sed 's/^/  linking /'
                    ;;
            esac
        else
            # .env files
            if [ -r "$path" ]; then
                msg +1 "  appending $path"
                no-comments "$path" >>"$EXPWD"/"${path##*.}"
            fi
        fi
    fi
done

#!/usr/bin/env bash
# exp-run -- run an experiment with given parameters
# Usage: exp run NAME=VALUE [NAME=VALUE]...
#
# Author: Jaeho Shin <netj@cs.stanford.edu>
# Created: 2012-11-01
set -eu

[ $# -ge 1 ] || usage "$0" "At least one NAME=VALUE pairs must be given"

EXPROOT=$(exp-findroot)
: ${EXPRUN:=$(new-run-id)}
export EXPROOT EXPRUN EXPWD="$EXPROOT/$EXPRUN"
EXPARCHIVE="$EXPROOT"/.exp/files

# archive everything when run exits
cleanup() {
    local c=$?
    set +e
    (
    set -e
    cd "$EXPWD" 2>/dev/null
    msg +2 "Archiving $EXPRUN to .exp/files/"
    chmod a-w output stdout stderr 2>/dev/null || true
    archive "$EXPARCHIVE" . ! -path ./output ! -path ./stdout ! -path ./stderr
    )
    exit $c
}
trap cleanup EXIT

# assemble it for running and measuring outputs
exp-assemble "$EXPWD" "$@"

# run it
cd "$EXPWD"
msg "Running $EXPRUN with $*"
record-run &
runpid=$!

# watch stdout and stderr
trap "kill -TERM $runpid; wait $runpid" INT QUIT TERM
be-quiet +1 || {
tail -qF stdout --pid=$runpid      2>/dev/null &
tail -qF stderr --pid=$runpid 1>&2 2>/dev/null &
}
wait || true

if [ -e exitcode ]; then
    exitcode=$(cat exitcode)
    msg "Finished $EXPRUN with exitcode $exitcode"
else
    exitcode=127
    msg "Interrupted $EXPRUN"
    exit $exitcode
fi

# run output measurements
for mx in measures/*/measure; do
    m=$(basename "$(dirname "$mx")")
    if [ -x "$mx" ]; then
        echo "$m=$(escape-args-for-shell "$(
        # run measure drivers under the same env
        export $(cat ./env) EXPMEASURE=${mx%/measure}
        "$mx"
        )")"
    fi
done >output

# incrementally update the index with this run
exp-index init
exp-index update .

exit $exitcode
